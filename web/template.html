<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{BRANCH}} @ {{COMMIT}}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'Berkeley Mono';
      src: local('Berkeley Mono'), local('BerkeleyMono-Regular');
      font-weight: 400;
    }
    @font-face {
      font-family: 'Berkeley Mono';
      src: local('Berkeley Mono Bold'), local('BerkeleyMono-Bold');
      font-weight: 600;
    }

    :root {
      --bg-deep: #09090b;
      --bg-base: #0c0c0e;
      --bg-elevated: #141417;
      --bg-hover: #1a1a1f;
      --border-subtle: rgba(255,255,255,0.06);
      --border-medium: rgba(255,255,255,0.1);
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-tertiary: #52525b;
      --accent: #3b82f6;
      --accent-muted: rgba(59,130,246,0.15);
      --add: #22c55e;
      --add-muted: rgba(34,197,94,0.15);
      --del: #ef4444;
      --del-muted: rgba(239,68,68,0.15);
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-mono: 'Berkeley Mono', 'SF Mono', 'Menlo', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 14px; -webkit-font-smoothing: antialiased; }
    body { font-family: var(--font-sans); background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--bg-base);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 32px;
    }

    .header-top {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .branch {
      font-family: var(--font-mono);
      font-size: 0.85rem;
      color: var(--accent);
      background: var(--accent-muted);
      padding: 4px 10px;
      border-radius: 4px;
    }

    .commit {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }

    .stats {
      display: flex;
      gap: 12px;
      margin-left: auto;
      font-family: var(--font-mono);
      font-size: 0.8rem;
    }

    .stats .files { color: var(--text-secondary); }
    .stats .add { color: var(--add); }
    .stats .del { color: var(--del); }

    .summary {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 8px;
    }

    /* Main */
    .main {
      padding: 24px 32px 80px;
    }

    .file-section {
      margin-bottom: 24px;
    }

    .file-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px 6px 0 0;
      border-bottom: none;
      cursor: pointer;
      user-select: none;
    }

    .file-header:hover {
      background: var(--bg-hover);
    }

    .file-section.collapsed .file-header {
      border-radius: 6px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .file-section.collapsed .diff-container {
      display: none;
    }

    .file-header .toggle {
      color: var(--text-tertiary);
      font-size: 0.75rem;
      margin-right: 8px;
      width: 12px;
    }

    .file-header .path {
      font-family: var(--font-mono);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .file-header .changes {
      font-family: var(--font-mono);
      font-size: 0.75rem;
      display: flex;
      gap: 8px;
    }

    .file-header .add { color: var(--add); }
    .file-header .del { color: var(--del); }

    .diff-container {
      border: 1px solid var(--border-subtle);
      border-radius: 0 0 6px 6px;
      overflow: hidden;
      background: var(--bg-base);
      --diffs-font-family: 'Berkeley Mono', 'SF Mono', 'Menlo', monospace;
      --diffs-font-size: 15px;
      --diffs-line-height: 24px;
    }

    /* Keyboard hints */
    .hints {
      position: fixed;
      bottom: 16px;
      right: 16px;
      display: flex;
      gap: 12px;
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 0.7rem;
      color: var(--text-tertiary);
    }

    .hints kbd {
      padding: 2px 5px;
      background: var(--bg-hover);
      border-radius: 3px;
      font-family: var(--font-mono);
    }

    /* Empty state */
    .empty {
      text-align: center;
      padding: 48px;
      color: var(--text-tertiary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-top">
      <span class="branch" id="branch">{{BRANCH}}</span>
      <span class="commit" id="commit">{{COMMIT}}</span>
      <div class="stats">
        <span class="files" id="file-count"></span>
        <span class="add" id="total-add"></span>
        <span class="del" id="total-del"></span>
      </div>
    </div>
    <div class="summary" id="summary"></div>
  </header>

  <main class="main" id="main">
    <div class="empty">Loading...</div>
  </main>

  <div class="hints">
    <span><kbd>j</kbd>/<kbd>k</kbd> navigate files</span>
    <span><kbd>r</kbd> toggle collapse</span>
  </div>

  <script type="module">
    import { FileDiff, parsePatchFiles } from 'https://esm.sh/@pierre/diffs@1.0.6';

    // Decode base64 JSON data
    const b64 = '{{REVIEW_DATA_B64}}';
    let DATA;
    try {
      DATA = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(b64), c => c.charCodeAt(0))));
    } catch {
      DATA = { files: [], patch: '', branch: '', commit: '', summary: '' };
    }

    const escapeHtml = (str) => String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;');

    // Update header
    document.getElementById('branch').textContent = DATA.branch || 'Unknown';
    document.getElementById('commit').textContent = DATA.commit || '';
    document.getElementById('summary').textContent = DATA.summary || '';

    // Calculate totals
    const totalAdd = DATA.files?.reduce((sum, f) => sum + (f.additions || 0), 0) || 0;
    const totalDel = DATA.files?.reduce((sum, f) => sum + (f.deletions || 0), 0) || 0;
    document.getElementById('file-count').textContent = `${DATA.files?.length || 0} files`;
    document.getElementById('total-add').textContent = `+${totalAdd}`;
    document.getElementById('total-del').textContent = `-${totalDel}`;

    // Parse patches
    const patches = parsePatchFiles(DATA.patch || '', 'quickdiff');
    const diffByPath = new Map(patches.flatMap(p => p.files).map(f => [f.name, f]));

    const main = document.getElementById('main');
    main.innerHTML = '';

    if (!DATA.files?.length) {
      main.innerHTML = '<div class="empty">No files changed</div>';
    } else {
      DATA.files.forEach((file, idx) => {
        const section = document.createElement('div');
        section.className = 'file-section';
        section.dataset.index = idx;
        section.innerHTML = `
          <div class="file-header">
            <span class="toggle">▼</span>
            <span class="path">${escapeHtml(file.path)}</span>
            <span class="changes">
              <span class="add">+${file.additions || 0}</span>
              <span class="del">-${file.deletions || 0}</span>
            </span>
          </div>
          <div class="diff-container"></div>
        `;
        main.appendChild(section);

        // Toggle collapse
        const header = section.querySelector('.file-header');
        const toggle = section.querySelector('.toggle');
        header.addEventListener('click', () => {
          section.classList.toggle('collapsed');
          toggle.textContent = section.classList.contains('collapsed') ? '▶' : '▼';
        });

        const diffContainer = section.querySelector('.diff-container');
        const fileDiff = diffByPath.get(file.path);

        if (!fileDiff) {
          diffContainer.innerHTML = '<div class="empty">No diff available</div>';
          return;
        }

        // Render with @pierre/diffs
        new FileDiff({
          theme: 'pierre-dark',
          diffStyle: 'split',
          diffIndicators: 'bars',
          overflow: 'wrap',
        }).render({ fileDiff, containerWrapper: diffContainer, lineAnnotations: [] });
      });
    }

    // Keyboard navigation
    let idx = 0;
    const sections = [...document.querySelectorAll('.file-section')];

    document.addEventListener('keydown', e => {
      const tag = e.target?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;
      
      if (e.key === 'j') {
        idx = Math.min(idx + 1, sections.length - 1);
        sections[idx]?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      if (e.key === 'k') {
        idx = Math.max(idx - 1, 0);
        sections[idx]?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      if (e.key === 'r') {
        const sec = sections[idx];
        if (sec) {
          sec.classList.toggle('collapsed');
          sec.querySelector('.toggle').textContent = sec.classList.contains('collapsed') ? '▶' : '▼';
        }
      }
    });
  </script>
</body>
</html>
